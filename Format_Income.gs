/**
 * Скрипт для форматирования листа "Все" по месяцам
 * Каждый месяц получает свой цвет фона для всех строк
 */

// ============================================================================
// КОНФИГУРАЦИЯ
// ============================================================================
var КОНФИГ_ФОРМАТИРОВАНИЯ = {
  // Имя листа для форматирования
  ЛИСТ_ДАННЫХ: 'Все',
  
  // Колонка с датой (B = 2)
  КОЛОНКА_ДАТЫ: 2,
  
  // Первая строка данных (1 = заголовки, 2 = данные)
  ПЕРВАЯ_СТРОКА_ДАННЫХ: 2,
  
  // Цвета для каждого месяца (12 цветов)
  ЦВЕТА_МЕСЯЦЕВ: [
    '#E8F4F8',  // Январь - светло-голубой
    '#FFF2CC',  // Февраль - светло-желтый
    '#E2EFDA',  // Март - светло-зеленый
    '#F4B084',  // Апрель - светло-оранжевый
    '#D5E8D4',  // Май - светло-салатовый
    '#F8CECC',  // Июнь - светло-розовый
    '#DEEBF7',  // Июль - светло-синий
    '#FFE699',  // Август - желтый
    '#F2F2F2',  // Сентябрь - светло-серый
    '#E1D5E7',  // Октябрь - светло-фиолетовый
    '#D0CECE',  // Ноябрь - серый
    '#FCE4D6'   // Декабрь - персиковый
  ]
};

// ============================================================================
// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
// ============================================================================

/**
 * Преобразует значение ячейки в дату
 */
function получитьДату(значение) {
  if (!значение) return null;
  
  // Если это уже объект Date
  if (значение instanceof Date) {
    return значение;
  }
  
  // Если это строка, пытаемся преобразовать
  if (typeof значение === 'string') {
    // Формат DD.MM.YYYY
    var части = значение.split('.');
    if (части.length === 3) {
      return new Date(части[2], части[1] - 1, части[0]);
    }
    // Пробуем стандартное преобразование
    var дата = new Date(значение);
    if (!isNaN(дата.getTime())) {
      return дата;
    }
  }
  
  return null;
}

/**
 * Получает номер месяца из даты (0-11)
 */
function получитьНомерМесяца(дата) {
  if (!дата || !(дата instanceof Date) || isNaN(дата.getTime())) {
    return null;
  }
  return дата.getMonth(); // 0 = январь, 11 = декабрь
}

/**
 * Получает цвет для месяца по его номеру (0-11)
 */
function получитьЦветМесяца(номерМесяца) {
  if (номерМесяца === null || номерМесяца < 0 || номерМесяца > 11) {
    return null;
  }
  return КОНФИГ_ФОРМАТИРОВАНИЯ.ЦВЕТА_МЕСЯЦЕВ[номерМесяца];
}

/**
 * Получает лист по имени с обработкой ошибок
 */
function получитьЛист(spreadsheet, имяЛиста) {
  var лист = spreadsheet.getSheetByName(имяЛиста);
  if (!лист) {
    var ошибка = 'Лист "' + имяЛиста + '" не найден!';
    Logger.log('ОШИБКА: ' + ошибка);
    throw new Error(ошибка);
  }
  return лист;
}

/**
 * Основная функция форматирования листа "Все" по месяцам
 */
function Format_Income() {
  try {
    Logger.log('=== Начало форматирования листа "Все" ===');
    
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // Получаем лист
    var лист;
    try {
      лист = получитьЛист(spreadsheet, КОНФИГ_ФОРМАТИРОВАНИЯ.ЛИСТ_ДАННЫХ);
    } catch (error) {
      SpreadsheetApp.getUi().alert(error.message);
      return;
    }
    
    // Определяем последнюю строку с данными
    var последняяСтрока = лист.getLastRow();
    if (последняяСтрока < КОНФИГ_ФОРМАТИРОВАНИЯ.ПЕРВАЯ_СТРОКА_ДАННЫХ) {
      Logger.log('Нет данных для форматирования');
      SpreadsheetApp.getUi().alert('На листе "' + КОНФИГ_ФОРМАТИРОВАНИЯ.ЛИСТ_ДАННЫХ + '" нет данных для форматирования');
      return;
    }
    
    Logger.log('Чтение данных с листа "' + КОНФИГ_ФОРМАТИРОВАНИЯ.ЛИСТ_ДАННЫХ + '"...');
    Logger.log('Последняя строка: ' + последняяСтрока);
    
    // Определяем количество колонок (берем из первой строки данных)
    var последняяКолонка = лист.getLastColumn();
    Logger.log('Последняя колонка: ' + последняяКолонка);
    
    // Читаем все даты одним батчем для оптимизации
    var диапазонДат = лист.getRange(
      КОНФИГ_ФОРМАТИРОВАНИЯ.ПЕРВАЯ_СТРОКА_ДАННЫХ, 
      КОНФИГ_ФОРМАТИРОВАНИЯ.КОЛОНКА_ДАТЫ, 
      последняяСтрока - КОНФИГ_ФОРМАТИРОВАНИЯ.ПЕРВАЯ_СТРОКА_ДАННЫХ + 1, 
      1
    );
    var значенияДат = диапазонДат.getValues();
    
    // Группируем строки по месяцам
    var строкиПоМесяцам = {};
    var названияМесяцев = [
      'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
      'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
    ];
    
    for (var i = 0; i < значенияДат.length; i++) {
      var датаЗначение = значенияДат[i][0];
      var дата = получитьДату(датаЗначение);
      
      if (!дата) {
        Logger.log('Не удалось преобразовать дату в строке ' + (КОНФИГ_ФОРМАТИРОВАНИЯ.ПЕРВАЯ_СТРОКА_ДАННЫХ + i) + ': ' + датаЗначение);
        continue;
      }
      
      var номерМесяца = получитьНомерМесяца(дата);
      if (номерМесяца === null) {
        continue;
      }
      
      var номерСтроки = КОНФИГ_ФОРМАТИРОВАНИЯ.ПЕРВАЯ_СТРОКА_ДАННЫХ + i;
      
      // Инициализируем массив для месяца, если его еще нет
      if (!строкиПоМесяцам[номерМесяца]) {
        строкиПоМесяцам[номерМесяца] = [];
      }
      
      строкиПоМесяцам[номерМесяца].push(номерСтроки);
    }
    
    Logger.log('Группировка завершена. Месяцев найдено: ' + Object.keys(строкиПоМесяцам).length);
    
    // Применяем форматирование для каждого месяца
    var обработаноСтрок = 0;
    for (var номерМесяца in строкиПоМесяцам) {
      var строкиМесяца = строкиПоМесяцам[номерМесяца];
      var цвет = получитьЦветМесяца(parseInt(номерМесяца));
      
      if (!цвет || строкиМесяца.length === 0) {
        continue;
      }
      
      Logger.log('Форматирование ' + строкиМесяца.length + ' строк для ' + названияМесяцев[parseInt(номерМесяца)]);
      
      // Применяем цвет ко всем строкам месяца
      // Для оптимизации группируем последовательные строки
      var текущаяГруппа = [строкиМесяца[0]];
      var началоГруппы = строкиМесяца[0];
      
      for (var j = 1; j < строкиМесяца.length; j++) {
        var текущаяСтрока = строкиМесяца[j];
        var предыдущаяСтрока = строкиМесяца[j - 1];
        
        // Если строки идут подряд, добавляем в группу
        if (текущаяСтрока === предыдущаяСтрока + 1) {
          текущаяГруппа.push(текущаяСтрока);
        } else {
          // Применяем форматирование к группе последовательных строк
          if (текущаяГруппа.length > 0) {
            var количествоСтрок = текущаяГруппа.length;
            var диапазон = лист.getRange(началоГруппы, 1, количествоСтрок, последняяКолонка);
            диапазон.setBackground(цвет);
            обработаноСтрок += количествоСтрок;
          }
          
          // Начинаем новую группу
          текущаяГруппа = [текущаяСтрока];
          началоГруппы = текущаяСтрока;
        }
      }
      
      // Применяем форматирование к последней группе
      if (текущаяГруппа.length > 0) {
        var количествоСтрок = текущаяГруппа.length;
        var диапазон = лист.getRange(началоГруппы, 1, количествоСтрок, последняяКолонка);
        диапазон.setBackground(цвет);
        обработаноСтрок += количествоСтрок;
      }
    }
    
    Logger.log('=== Форматирование завершено ===');
    Logger.log('Обработано строк: ' + обработаноСтрок);
    
    var сообщение = 'Форматирование завершено!\n' +
                    'Обработано строк: ' + обработаноСтрок + '\n' +
                    'Месяцев: ' + Object.keys(строкиПоМесяцам).length;
    SpreadsheetApp.getUi().alert(сообщение);
    
  } catch (error) {
    var сообщение = 'Произошла ошибка при форматировании: ' + error.toString();
    Logger.log('КРИТИЧЕСКАЯ ОШИБКА: ' + сообщение);
    Logger.log('Стек вызовов: ' + error.stack);
    SpreadsheetApp.getUi().alert(сообщение);
    throw error;
  }
}
